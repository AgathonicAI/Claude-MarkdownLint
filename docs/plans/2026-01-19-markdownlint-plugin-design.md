# Markdownlint Plugin Design

## Overview

A Claude Code plugin that provides markdownlint capabilities - linting markdown files for style/format issues and automatically repairing them, with Claude-assisted fixes for issues that can't be auto-fixed.

## Distribution

- Hosted on GitHub
- Installed via `claude plugins add github:username/claude-skill-markdownlint`

## Plugin Structure

```text
claude-skill-markdownlint/
├── plugin.json              # Plugin manifest
├── src/
│   └── index.ts             # MCP tool implementations
├── package.json             # Dependencies
├── tsconfig.json
├── README.md
├── CLAUDE.md
└── docs/
    └── plans/
```

## Plugin Manifest (plugin.json)

```json
{
  "name": "markdownlint",
  "description": "Lint and fix markdown files with Claude-assisted repairs",
  "version": "1.0.0",
  "tools": ["lint_markdown", "fix_markdown", "init_markdownlint_config"],
  "hooks": {
    "post_edit": {
      "pattern": "**/*.md",
      "tool": "lint_markdown",
      "params": {
        "scope": "file",
        "files": ["$EDITED_FILE"]
      },
      "silent_on_success": true
    }
  }
}
```

## MCP Tools

### lint_markdown

Check markdown files for issues.

**Parameters:**

- `files` (optional): Array of file paths. Defaults to changed files via git.
- `scope` (optional): `"changed"` | `"all"` | `"file"`. Defaults to `"changed"`.

**Returns:** Structured object with issues grouped by file, including line numbers, rule IDs, messages, and whether each is auto-fixable.

**Behavior:** Checks prerequisites first, returns clear error if npx/Node missing.

### fix_markdown

Apply fixes to markdown issues.

**Parameters:**

- `files` (optional): Array of file paths. Defaults to changed files.
- `auto_only` (optional): Boolean. If true, only apply markdownlint auto-fixes. Defaults to false.

**Returns:** Summary of fixes applied, any remaining issues.

**Behavior:** Runs `--fix` first, then returns remaining issues for Claude to handle.

### init_markdownlint_config

Create starter `.markdownlint.jsonc` config.

**Parameters:** None

**Returns:** Success/failure, path to created config.

**Behavior:** Checks if config exists first, creates starter if not.

## Hooks Integration

The plugin registers a hook that triggers linting after markdown edits.

**Behavior:**

- Fires after any `.md` file is edited
- Runs `lint_markdown` on just that file
- If no issues, produces no output (silent on success)
- If issues found, Claude receives structured results and can offer fixes

**User control:**

- Hooks can be disabled per-project via `.claude/settings.json`
- User can run `/markdownlint` manually regardless of hook state
- Hook respects `<!-- markdownlint-disable -->` in files

**Session memory:**
- Plugin tracks which issues user has declined to fix this session
- Avoids repeatedly prompting about the same issue

## Configuration

### Plugin Configuration

**Location:**
- Project-level: `.claude/plugins/markdownlint.json`
- Global (user-level): `~/.claude/plugins/markdownlint.json`
- Project overrides global

**Structure:**
```json
{
  "claude_assisted_fixes": "ask" | "auto" | "never",
  "proactive_linting": true | false,
  "default_scope": "changed" | "all" | "file"
}
```

**Defaults:**
```json
{
  "claude_assisted_fixes": "ask",
  "proactive_linting": true,
  "default_scope": "changed"
}
```

### Markdownlint Configuration

Linting rules stay in `.markdownlint.jsonc` (standard markdownlint location).

**Starter config:**
```jsonc
{
  // Starter config generated by markdownlint plugin
  "default": true,

  // Relaxed rules for practical use
  "MD013": false,           // Line length - often impractical
  "MD033": false,           // Inline HTML - needed for badges, details, etc.
  "MD041": false,           // First line h1 - not always wanted

  // Keep these strict (catch real issues)
  "MD001": true,            // Heading increment (no skipping h1 to h3)
  "MD012": { "maximum": 1 },// Multiple blank lines
  "MD022": true,            // Headings need blank lines
  "MD031": true,            // Fenced code needs blank lines
  "MD047": true             // File should end with newline
}
```

## Workflow

### Linting Flow

1. Check prerequisites (npx/Node available)
2. If no config exists, offer to create starter config
3. Determine files to lint based on scope
4. Run `npx markdownlint-cli2 --json` on those files
5. Parse and return structured results

### Fix Flow

1. Run `markdownlint-cli2 --fix` for auto-fixable issues
2. Re-run lint to verify fixes and get remaining issues
3. For non-auto-fixable issues:
   - Report the issue with context
   - Offer: "Autofix is not available for [issue], but I can fix this myself. Would you like that?"
   - If yes, Claude applies the fix
   - Re-run markdownlint to verify the fix worked
   - If issue persists, report and offer alternative approach
4. After first successful Claude-assisted fix, ask about preference for future fixes

### Output Format

```
## Markdown Lint Results

Found 3 issues in 2 files:

**README.md**
- Line 12: MD022 - Headings should be surrounded by blank lines
- Line 45: MD031 - Fenced code blocks should be surrounded by blank lines

**docs/guide.md**
- Line 8: MD001 - Heading levels should only increment by one level at a time

2 issues are auto-fixable.
```

## Error Handling

| Scenario | Behavior |
|----------|----------|
| No npx | Return structured error with Node.js installation guidance |
| No git repo | Fall back to linting all `*.md` files in current directory |
| No changed `.md` files | Return "No markdown files to check" |
| markdownlint fails to run | Return error with Node.js version check suggestion |
| Config file has syntax errors | Return parse error with file location |

## Implementation Details

### Dependencies

```json
{
  "dependencies": {
    "markdownlint-cli2": "^0.13.0"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "@types/node": "^20.0.0"
  }
}
```

### Core Approach

1. **Prerequisite check:** Use `execFile` to test `npx --version` (avoid shell injection)
2. **Running markdownlint:** Use `execFile` with `npx` and args array for structured output
3. **Parsing results:** JSON output provides file, line, rule, message, fixable status
4. **Applying fixes:** Run with `--fix` flag, then re-run to get remaining issues
5. **Config creation:** Write starter config using `fs.writeFileSync`

**Security note:** Use `execFile` instead of `exec` to prevent command injection vulnerabilities. Pass arguments as arrays, not interpolated strings.

### Git Integration

- Use `execFile('git', ['diff', '--name-only', '--diff-filter=ACMR', 'HEAD'])` for changed files
- Filter to `*.md` extension
- Handle untracked files with `git ls-files --others --exclude-standard`

## Claude-Assisted Fix Scope

Issues Claude can fix when markdownlint auto-fix is unavailable:

- Heading level issues (MD001) - adjust heading levels
- Duplicate headings (MD024) - suggest renamed headings
- Link issues (MD042, MD052) - fix malformed links
- List formatting (MD004, MD030) - normalize list markers/spacing

**Guardrails:**
- Claude explains what it will change before doing it (unless preference set to auto)
- Only fix the specific issue flagged, don't refactor surrounding content
- If the fix is ambiguous, ask user for guidance
